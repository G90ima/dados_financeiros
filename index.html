<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {font-family: Arial, sans-serif; color: rgb(48,124,86); background:#f4f4f4; margin:0;}
        .menu {background:#333; overflow:hidden;}
        .menu a {float:left; display:block; color:white; text-align:center; padding:14px 16px; text-decoration:none;}
        .menu a:hover {background:#ddd; color:black;}
        .menu a.active {background:#4CAF50;}
        .container {max-width:1200px; margin:20px auto; padding:20px; background:white; box-shadow:0 0 10px rgba(0,0,0,0.1);}
        h2 {text-align:center;}
        .summary {display:flex; gap:20px; margin-bottom:20px; justify-content:center; flex-wrap:wrap;}
        .summary label {display:flex; flex-direction:column; font-weight:bold;}
        .summary input {padding:5px; border:1px solid #ddd; border-radius:4px;}
        .buttons {text-align:center; margin:20px 0;}
        button {margin:0 5px; padding:10px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;}
        button:hover {background:#45a049;}
        table {width:100%; border-collapse:collapse; margin-top:20px;}
        th, td {border:1px solid #ddd; padding:8px; text-align:left;}
        th {background:#f2f2f2; font-weight:bold;}
        input, select {width:100%; padding:4px; box-sizing:border-box; border:1px solid #ccc; border-radius:2px;}
        .valorTotal {font-weight:bold;}
    </style>
</head>
<body>
    <div class="menu">
        <a href="index.html" class="active">Controle</a>
        <a href="dados_salvos.html">Dados Salvos</a>
        <a href="contact.html">Contato</a>
    </div>

    <div class="container">
        <h2>Controle Financeiro</h2>

        <div class="summary">
            <label>Valor Salarial: <input type="text" id="valorSalarial" value="0,00" oninput="updateSummary()"></label>
            <label>Total Pago: <input type="text" id="totalPago" value="0,00" readonly></label>
            <label>Total Não Pago: <input type="text" id="totalNaoPago" value="0,00" readonly></label>
        </div>

        <div class="buttons">
            <button onclick="importExcel()">Importar Excel</button>
            <button onclick="exportToExcel()">Exportar Excel</button>
            <button onclick="saveData()">Salvar Dados</button>
            <button id="addRowButton">Adicionar Linha</button>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Contas</th><th>Horário</th><th>Data</th><th>Vencimento</th><th>aumento</th>
                        <th>Banco</th><th>Valor</th><th>Acrescimo</th><th class="valorTotal">Valor Total</th><th>Pago</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" class="conta" oninput="calculateTotal(this)"></td>
                        <td><input type="text" class="horario" readonly onclick="displayCurrentTime(this)"></td>
                        <td><input type="text" class="data datepicker" readonly onclick="displayCurrentDate(this)"></td>
                        <td><input type="text" class="vencimento datepicker" oninput="calculateTotal(this)"></td>
                        <td>
                            <select class="aumento" onchange="calculateTotal(this)">
                                <option value="0.025">0.025%</option>
                                <option value="0.5">0.5%</option>
                                <option value="1">1%</option>
                                <option value="2">2%</option>
                                <option value="3">3%</option>
                                <option value="4">0,7%</option>
                                <option value="5">0,8%</option>
                                <option value="0" selected>0%</option>
                            </select>
                        </td>
                        <td>
                            <select class="prazo" onchange="calculateTotal(this)">
                                <option value="BB">BB</option>
                                <option value="Bradesco" selected>Bradesco</option>
                                <option value="PAN">PAN</option>
                                <option value="CAIXA">CAIXA</option>
                                <option value="Inter">Inter</option>
                            </select>
                        </td>
                        <td><input type="text" class="valor" value="0,00" oninput="calculateTotal(this)"></td>
                        <td><input type="text" class="valorAcrescimo" value="0,00" readonly></td>
                        <td><input type="text" class="valorTotal" value="0,00" readonly></td>
                        <td><input type="checkbox" class="pago" onclick="calculateTotal(this)"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ==================== FUNÇÃO QUE ELIMINA O NaN / nannnnnn ====================
        function safeValue(val, fallback = '') {
            if (val === null || val === undefined || val === '') return fallback;
            const s = String(val).trim();
            if (s === 'NaN' || s.includes('NaN') || s.includes('Invalid') || s === 'undefined') return fallback;
            return s;
        }

        $(function () {
            $(".datepicker").datepicker({ dateFormat: 'yy-mm-dd' });
        });

        function displayCurrentTime(cell) {
            cell.value = new Date().toLocaleTimeString();
            calculateTotal(cell);
        }

        function displayCurrentDate(cell) {
            cell.value = new Date().toISOString().split('T')[0];
            calculateTotal(cell);
        }

        function calculateTotal(element) {
            const row = element.closest('tr');
            const valor = parseFloat(row.querySelector('.valor').value.replace(',', '.')) || 0;
            const aumento = parseFloat(row.querySelector('.aumento').value) || 0;
            const acrescimo = (valor * aumento / 100).toFixed(2);
            const valorTotal = (valor + parseFloat(acrescimo)).toFixed(2);

            row.querySelector('.valorAcrescimo').value = acrescimo.replace('.', ',');
            row.querySelector('.valorTotal').value = valorTotal.replace('.', ',');
            row.querySelector('.valorTotal').style.color = row.querySelector('.pago').checked ? 'black' : 'red';

            updateSummary();
        }

        function updateSummary() {
            let totalPago = 0, totalNaoPago = 0;
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const valorTotal = parseFloat(row.querySelector('.valorTotal').value.replace(',', '.')) || 0;
                const pago = row.querySelector('.pago').checked;
                if (pago) totalPago += valorTotal;
                else totalNaoPago += valorTotal;
            });
            document.getElementById('totalPago').value = totalPago.toFixed(2).replace('.', ',');
            document.getElementById('totalNaoPago').value = totalNaoPago.toFixed(2).replace('.', ',');
        }

        function saveData() {
            const data = [];
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                data.push({
                    conta: row.querySelector('.conta').value,
                    horario: row.querySelector('.horario').value,
                    data: row.querySelector('.data').value,
                    vencimento: row.querySelector('.vencimento').value,
                    aumento: row.querySelector('.aumento').value,
                    prazo: row.querySelector('.prazo').value,
                    valor: row.querySelector('.valor').value,
                    valorAcrescimo: row.querySelector('.valorAcrescimo').value,
                    valorTotal: row.querySelector('.valorTotal').value,
                    pago: row.querySelector('.pago').checked
                });
            });
            localStorage.setItem('financeData', JSON.stringify(data));
            localStorage.setItem('valorSalarial', document.getElementById('valorSalarial').value);
            alert('Dados salvos com sucesso!');
        }

        function populateTable(jsonRows) {
            const table = document.getElementById('dataTable');
            const template = table.rows[1].cloneNode(true);
            while (table.rows.length > 1) table.deleteRow(1);

            jsonRows.forEach(rowData => {
                const newRow = template.cloneNode(true);
                newRow.querySelector('.conta').value          = safeValue(rowData[0]);
                newRow.querySelector('.horario').value        = safeValue(rowData[1]);
                newRow.querySelector('.data').value           = safeValue(rowData[2]);
                newRow.querySelector('.vencimento').value     = safeValue(rowData[3]);   // Nunca mais NaN
                newRow.querySelector('.aumento').value        = safeValue(rowData[4], '0');
                newRow.querySelector('.prazo').value          = safeValue(rowData[5], 'Bradesco');
                newRow.querySelector('.valor').value          = safeValue(rowData[6], '0,00');
                newRow.querySelector('.valorAcrescimo').value = safeValue(rowData[7], '0,00');
                newRow.querySelector('.valorTotal').value     = safeValue(rowData[8], '0,00');
                newRow.querySelector('.pago').checked         = !!rowData[9];
                table.appendChild(newRow);
                calculateTotal(newRow.querySelector('.valor'));
            });

            if (table.rows.length === 1) table.appendChild(template.cloneNode(true));
            updateSummary();
        }

        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = ev => {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1}).slice(1);
                    populateTable(json);
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        function exportToExcel() {
            const data = [];
            const headers = Array.from(document.querySelectorAll('#dataTable thead th')).map(th => th.textContent.trim());
            data.push(headers);

            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('input, select').forEach(el => {
                    rowData.push(el.type === 'checkbox' ? (el.checked ? 'Sim' : 'Não') : el.value);
                });
                data.push(rowData);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Financeiro');
            XLSX.writeFile(wb, 'controle_financeiro.xlsx');
        }

        document.getElementById('addRowButton').addEventListener('click', () => {
            const table = document.getElementById('dataTable');
            const newRow = table.rows[1].cloneNode(true);
            newRow.querySelectorAll('input, select').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else if (el.type !== 'button') el.value = el.classList.contains('valor') || el.classList.contains('valorAcrescimo') || el.classList.contains('valorTotal') ? '0,00' : '';
            });
            table.appendChild(newRow);
        });

        // Carregar dados salvos ao abrir a página
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('financeData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    const rows = data.map(d => [
                        d.conta, d.horario, d.data, d.vencimento, d.aumento,
                        d.prazo, d.valor, d.valorAcrescimo, d.valorTotal, d.pago
                    ]);
                    populateTable(rows);
                } catch(e) { console.error(e); }
            }
            const salary = localStorage.getItem('valorSalarial');
            if (salary) document.getElementById('valorSalarial').value = safeValue(salary, '0,00');

            updateSummary();
        });
    </script>
</body>
</html>
